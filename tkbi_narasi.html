<!DOCTYPE html>

<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<title>TKBI v3 Narasi</title>

<script src="https://cdn.tailwindcss.com"></script>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

<!-- Anti cache -->

<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
<meta http-equiv="Pragma" content="no-cache">
<meta http-equiv="Expires" content="0">

<style>
body { font-family: 'Inter', sans-serif; }
.tree-item { cursor: pointer; }
</style>

</head>

<body class="bg-gray-100 text-gray-800">

<div class="container mx-auto p-6">

<header class="text-center mb-8">
<h1 class="text-3xl md:text-4xl font-bold text-[#003f5c]">
TKBI Versi 3 – Narasi Teknis
</h1>
<p class="text-gray-600 mt-2">
Detail Pilar, DNSH, Safeguards, dan Logika Teknis
</p>
</header>

<!-- SEARCH -->

<div class="bg-white rounded-lg shadow p-4 mb-4">
<input id="searchBox"
type="text"
placeholder="Cari sektor atau aktivitas..."
class="w-full border rounded-lg p-3">
</div>

<!-- TREE -->

<div id="treeContainer" class="bg-white rounded-lg shadow p-6">
Loading narasi...
</div>

<!-- BACK -->

<div class="text-center mt-10">
<a href="tkbi.html"
class="inline-block bg-gray-800 text-white px-6 py-3 rounded-lg shadow hover:bg-gray-700">
⬅ Back to Explorer
</a>
</div>

</div>

<script>

// ===== ANTI CACHE =====
const VERSION = new Date().getTime();

let narasiData = {};
let flatData = [];

// ===== LOAD JSON =====
fetch("tkbi_v3_hierarchy_indonesia_correct.json?v=" + VERSION)
.then(res => {
    if(!res.ok) throw "File JSON tidak ditemukan";
    return res.json();
})
.then(data => {
    narasiData = data;
    flattenData();
    renderTree(flatData);
})
.catch(err => {
    document.getElementById("treeContainer").innerHTML =
    "<b style='color:red'>Error:</b> " + err;
});


// ===== FLATTEN =====
function flattenData(){

flatData = [];

Object.keys(narasiData).forEach(sektor => {

    Object.keys(narasiData[sektor]).forEach(kbli => {

        const obj = narasiData[sektor][kbli];

        flatData.push({
            sektor,
            kbli,
            aktivitas: obj.Aktivitas || "",
            klasifikasi: obj.Klasifikasi || "",
            pilar: obj.Pilar || [],
            dnsh: obj.DNSH || [],
            safeguards: obj.Safeguards || [],
            logic: obj.Logic || []
        });

    });

});

}


// ===== SEARCH =====
document.getElementById("searchBox").addEventListener("input", function(){

const keyword = this.value.toLowerCase();

const filtered = flatData.filter(row =>
    row.sektor.toLowerCase().includes(keyword) ||
    row.kbli.toLowerCase().includes(keyword) ||
    row.aktivitas.toLowerCase().includes(keyword)
);

renderTree(filtered);

});


// ===== TREE =====
function renderTree(data){

const container = document.getElementById("treeContainer");
container.innerHTML = "";

if(!data.length){
container.innerHTML = "Tidak ada data.";
return;
}

// grouping sektor
const grouped = {};

data.forEach(row => {
if(!grouped[row.sektor]) grouped[row.sektor] = [];
grouped[row.sektor].push(row);
});

// render sektor
Object.keys(grouped).forEach(sektor => {

    const sektorDiv = document.createElement("div");
    sektorDiv.className = "mb-4";

    const header = document.createElement("div");
    header.className = "tree-item font-semibold text-lg text-[#003f5c]";
    header.innerHTML = "▶ " + sektor;

    const children = document.createElement("div");
    children.style.display = "none";
    children.className = "ml-4 mt-2";

    header.onclick = () => {
        children.style.display =
        children.style.display === "none" ? "block" : "none";

        header.innerHTML =
        children.style.display === "block"
        ? "▼ " + sektor
        : "▶ " + sektor;
    };

    // aktivitas
    grouped[sektor].forEach(row => {

        const actDiv = document.createElement("div");
        actDiv.className = "border rounded mb-2 bg-gray-50";

        const actHeader = document.createElement("div");
        actHeader.className = "tree-item p-3 font-semibold";
        actHeader.innerHTML = "▶ " + row.aktivitas;

        const detail = document.createElement("div");
        detail.style.display = "none";
        detail.className = "p-3 text-sm";

        actHeader.onclick = () => {
            detail.style.display =
            detail.style.display === "none" ? "block" : "none";

            actHeader.innerHTML =
            detail.style.display === "block"
            ? "▼ " + row.aktivitas
            : "▶ " + row.aktivitas;
        };

        detail.innerHTML = `
        <b>KBLI:</b> ${row.kbli}<br>
        <b>Klasifikasi:</b> ${row.klasifikasi}<br>
        <b>Pilar:</b> ${row.pilar.join(", ")}<br>
        <b>DNSH:</b> ${row.dnsh.join(", ")}<br>
        <b>Safeguards:</b> ${row.safeguards.join(", ")}<br>
        <b>Logic:</b> ${Array.isArray(row.logic) ? row.logic.join("<br>") : ""}
        `;

        actDiv.appendChild(actHeader);
        actDiv.appendChild(detail);
        children.appendChild(actDiv);

    });

    sektorDiv.appendChild(header);
    sektorDiv.appendChild(children);
    container.appendChild(sektorDiv);

});

}

</script>

</body>
</html>
