<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<title>TKBI Versi 3 – Explorer Non-UMKM</title>

<script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

<style>
body { font-family: 'Inter', sans-serif; }
.tree-item { cursor: pointer; }
</style>
</head>

<body class="bg-gray-100 text-gray-800">

<div class="container mx-auto p-6">

<!-- HEADER -->
<header class="text-center mb-8">
<h1 class="text-3xl md:text-4xl font-bold text-[#003f5c]">
TKBI Versi 3 – Explorer Non-UMKM
</h1>

<p class="text-gray-600 mt-2">
Technical Screening Criteria – Taksonomi Keuangan Berkelanjutan Indonesia
</p>

<p class="text-sm text-gray-500 mt-1">
Created by Leonard Tiopan Panjaitan, MT, CSRA, CGPS, CPS
</p>
</header>

<!-- FILTER -->
<div class="bg-white rounded-lg shadow p-4 mb-4 flex flex-wrap gap-3">

<select id="filterClass" class="border rounded p-2">
  <option value="all">Semua Klasifikasi</option>
  <option value="Hijau">Hijau</option>
  <option value="Transisi">Transisi</option>
</select>

<input id="searchBox"
type="text"
placeholder="Cari sektor atau aktivitas..."
class="flex-1 border rounded p-2">

<button id="exportBtn"
class="bg-green-600 text-white px-4 py-2 rounded shadow hover:bg-green-700">
Export Excel
</button>

</div>

<!-- TREE -->
<div id="treeContainer" class="bg-white rounded-lg shadow p-6"></div>

<!-- BACK -->
<div class="text-center mt-10">
<a href="index.html"
class="inline-block bg-gray-800 text-white px-6 py-3 rounded-lg shadow hover:bg-gray-700">
⬅ Back to the Main Page
</a>
</div>

</div>

<script>

let tkbiData = [];
let filteredData = [];

// LOAD JSON
fetch("./tkbi_v3_hierarchy_indonesia_min.json")
.then(res => res.json())
.then(data => {
    tkbiData = data;
    filteredData = tkbiData;
    renderTree(filteredData);
});


// FILTER
function applyFilter(){
    const keyword = document.getElementById("searchBox").value.toLowerCase();
    const klas = document.getElementById("filterClass").value;

    const result = tkbiData.map(sektor => {

        const aktivitas = sektor.Aktivitas.filter(act => {

            const matchSearch =
                act.NamaAktivitas.toLowerCase().includes(keyword);

            const matchClass =
                klas === "all" ||
                act.Klasifikasi.includes(klas);

            return matchSearch && matchClass;
        });

        if(aktivitas.length > 0){
            return {...sektor, Aktivitas: aktivitas};
        }
    });

    filteredData = result.filter(x => x);
    renderTree(filteredData);
}

document.getElementById("searchBox").addEventListener("input", applyFilter);
document.getElementById("filterClass").addEventListener("change", applyFilter);


// RENDER TREE
function renderTree(data){

const container = document.getElementById("treeContainer");
container.innerHTML = "";

data.forEach(sektor => {

    const sektorDiv = document.createElement("div");
    sektorDiv.className = "mb-4";

    const header = document.createElement("div");
    header.className = "tree-item font-semibold text-lg text-[#003f5c]";
    header.innerHTML = "▶ " + sektor.Sektor;

    const children = document.createElement("div");
    children.style.display = "none";
    children.className = "ml-4 mt-2";

    header.onclick = () => {
        children.style.display = children.style.display === "none" ? "block" : "none";
        header.innerHTML = children.style.display === "block"
            ? "▼ " + sektor.Sektor
            : "▶ " + sektor.Sektor;
    };

    sektor.Aktivitas.forEach(act => {

        const actDiv = document.createElement("div");
        actDiv.className = "p-3 border rounded mb-2 bg-gray-50";

        actDiv.innerHTML = `
        <b>${act.NamaAktivitas}</b><br>
        <span class="text-xs text-blue-600">${act.Klasifikasi}</span>
        <div class="text-sm mt-2">${act.Keterangan}</div>
        `;

        children.appendChild(actDiv);
    });

    sektorDiv.appendChild(header);
    sektorDiv.appendChild(children);

    container.appendChild(sektorDiv);
});
}


// EXPORT EXCEL (CSV)
document.getElementById("exportBtn").addEventListener("click", () => {

    let rows = [["Sektor","Aktivitas","Klasifikasi","Keterangan"]];

    filteredData.forEach(sektor => {
        sektor.Aktivitas.forEach(act => {
            rows.push([
                sektor.Sektor,
                act.NamaAktivitas,
                act.Klasifikasi,
                act.Keterangan.replace(/<[^>]*>?/gm, "")
            ]);
        });
    });

    let csv = rows.map(e => e.join(",")).join("\n");

    const blob = new Blob([csv], { type: "text/csv" });
    const url = URL.createObjectURL(blob);

    const a = document.createElement("a");
    a.href = url;
    a.download = "TKBI_Filter.csv";
    a.click();
});

</script>

</body>
</html>
