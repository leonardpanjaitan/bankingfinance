<!DOCTYPE html>

<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<title>TKBI Versi 3 – Explorer Non-UMKM</title>

<script src="https://cdn.tailwindcss.com"></script>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

<!-- Anti cache -->

<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
<meta http-equiv="Pragma" content="no-cache">
<meta http-equiv="Expires" content="0">

<style>
body { font-family: 'Inter', sans-serif; }
.tree-item { cursor: pointer; }
</style>

</head>

<body class="bg-gray-100 text-gray-800">

<div class="container mx-auto p-6">

<header class="text-center mb-8">
<h1 class="text-3xl md:text-4xl font-bold text-[#003f5c]">
TKBI Versi 3 – Explorer Non-UMKM
</h1>

<p class="text-gray-600 mt-2">
Technical Screening Criteria – Taksonomi Keuangan Berkelanjutan Indonesia
</p>

<p class="text-sm text-gray-500 mt-1">
Created by Leonard Tiopan Panjaitan, MT, CSRA, CGPS, CPS
</p>
</header>

<!-- FILTER -->

<div class="bg-white rounded-lg shadow p-4 mb-4 flex flex-wrap gap-3">

<select id="filterClass" class="border rounded p-2">
<option value="all">Semua Klasifikasi</option>
<option value="Hijau">Hijau</option>
<option value="Transisi">Transisi</option>
</select>

<input id="searchBox"
type="text"
placeholder="Cari sektor atau aktivitas..."
class="flex-1 border rounded p-2">

<button id="exportBtn"
class="bg-green-600 text-white px-4 py-2 rounded shadow hover:bg-green-700">
Export Excel </button>

</div>

<!-- TREE -->

<div id="treeContainer" class="bg-white rounded-lg shadow p-6">
Loading data...
</div>

<div class="text-center mt-10">
<a href="index.html"
class="inline-block bg-gray-800 text-white px-6 py-3 rounded-lg shadow hover:bg-gray-700">
⬅ Back to the Main Page
</a>
</div>

</div>

<script>

// ===== ANTI CACHE VERSION
const VERSION = new Date().getTime();

// ===== DATA
let explorerData = [];

// ===== LOAD 4 JSON
async function loadTKBI(){

try{

const [coreRes, dnshRes, safeRes, logicRes] = await Promise.all([
fetch("./data/taxonomy_core.json?v=" + VERSION),
fetch("./data/dnsh.json?v=" + VERSION),
fetch("./data/safeguards.json?v=" + VERSION),
fetch("./data/logic.json?v=" + VERSION)
]);

if(!coreRes.ok) throw "taxonomy_core.json tidak ditemukan";

const core = await coreRes.json();
const dnsh = await dnshRes.json();
const safeguards = await safeRes.json();
const logic = await logicRes.json();

buildExplorer(core, dnsh, safeguards, logic);

}catch(err){

document.getElementById("treeContainer").innerHTML =
"<b style='color:red'>Error:</b> " + err +
"<br>Pastikan semua JSON ada di folder <b>/data</b>.";

console.error(err);

}

}

// ===== BUILD DATA
function buildExplorer(core, dnsh, safeguards, logic){

explorerData = [];

Object.keys(core).forEach(sektor => {

Object.keys(core[sektor]).forEach(tsc => {

Object.keys(core[sektor][tsc]).forEach(kbli => {

const item = core[sektor][tsc][kbli];

explorerData.push({
Sektor: sektor,
TSC: tsc,
KBLI: kbli,
Klasifikasi: item.Klasifikasi,
Aktivitas: item.Aktivitas,
DNSH: dnsh[tsc] || [],
Safeguards: safeguards[tsc] || [],
Logic: logic[tsc] || []
});

});

});

});

renderTree(explorerData);

}

// ===== FILTER
function applyFilter(){

const keyword =
document.getElementById("searchBox").value.toLowerCase();

const klas =
document.getElementById("filterClass").value;

const filtered = explorerData.filter(row => {

const matchSearch =
row.Aktivitas.toLowerCase().includes(keyword) ||
row.Sektor.toLowerCase().includes(keyword);

const matchClass =
klas === "all" ||
row.Klasifikasi.includes(klas);

return matchSearch && matchClass;

});

renderTree(filtered);

}

document.getElementById("searchBox").addEventListener("input", applyFilter);
document.getElementById("filterClass").addEventListener("change", applyFilter);


// ===== TREE
function renderTree(data){

const container = document.getElementById("treeContainer");
container.innerHTML = "";

if(data.length === 0){
container.innerHTML = "Tidak ada data.";
return;
}

const grouped = {};

data.forEach(row => {
if(!grouped[row.Sektor]) grouped[row.Sektor] = [];
grouped[row.Sektor].push(row);
});

Object.keys(grouped).forEach(sektor => {

const sektorDiv = document.createElement("div");
sektorDiv.className = "mb-4";

const header = document.createElement("div");
header.className = "tree-item font-semibold text-lg text-[#003f5c]";
header.innerHTML = "▶ " + sektor;

const children = document.createElement("div");
children.style.display = "none";
children.className = "ml-4 mt-2";

header.onclick = () => {
children.style.display =
children.style.display === "none" ? "block" : "none";

header.innerHTML =
children.style.display === "block"
? "▼ " + sektor
: "▶ " + sektor;
};

grouped[sektor].forEach(row => {

const div = document.createElement("div");
div.className = "p-3 border rounded mb-2 bg-gray-50";

div.innerHTML = `
<b>${row.Aktivitas}</b><br>
<span class="text-xs text-blue-600">${row.Klasifikasi}</span>
<div class="text-xs mt-2">
KBLI: ${row.KBLI} | TSC: ${row.TSC}
</div>
`;

children.appendChild(div);

});

sektorDiv.appendChild(header);
sektorDiv.appendChild(children);
container.appendChild(sektorDiv);

});

}

// ===== EXPORT
document.getElementById("exportBtn").addEventListener("click", () => {

let rows = [["Sektor","TSC","KBLI","Aktivitas","Klasifikasi"]];

explorerData.forEach(row => {
rows.push([
row.Sektor,
row.TSC,
row.KBLI,
row.Aktivitas,
row.Klasifikasi
]);
});

let csv = rows.map(e => e.join(",")).join("\n");

const blob = new Blob([csv], { type: "text/csv" });
const url = URL.createObjectURL(blob);

const a = document.createElement("a");
a.href = url;
a.download = "TKBI_Filter.csv";
a.click();

});

// START
loadTKBI();

</script>

</body>
</html>
